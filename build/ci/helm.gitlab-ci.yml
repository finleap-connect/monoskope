.helm:
  image: registry.gitlab.figo.systems/platform/helm-builder:1.14.3-rc1

lint:helm:monoskope:
  stage: test
  extends: .helm
  except:
    - schedules
  script:
    - make helm-dep-monoskope
    - make helm-lint-monoskope
  needs: []

lint:helm:gateway:
  stage: test
  extends: .helm
  except:
    - schedules
  script:
    - make helm-lint-gateway
  needs: []

lint:helm:eventstore:
  stage: test
  extends: .helm
  except:
    - schedules
  script:
    - make helm-lint-eventstore
  needs: []

lint:helm:commandhandler:
  stage: test
  extends: .helm
  except:
    - schedules
  script:
    - make helm-lint-commandhandler
  needs: []

deliver:chart:monoskope:
  stage: deliver
  extends: .helm
  only:
    - tags
  script:
    - VERSION=$(sh ./build/ci/configure_versions.sh)
    - VERSION=$VERSION make helm-set-version-gateway
    - VERSION=$VERSION make helm-set-version-eventstore
    - build-chart --chart-dir build/package/helm/monoskope --promote-version $VERSION
  needs:
    - lint:helm:gateway
    - lint:helm:eventstore
    - lint:helm:commandhandler
    - lint:helm:monoskope

deploy:monoskope:
  stage: deploy
  extends: .helm
  environment:
    name: figo-dev
  only:
    - tags
  script:
    - VERSION=$(sh ./build/ci/configure_versions.sh)
    - make helm-add-finleap
    - VERSION=$VERSION HELM_VALUES_FILE=examples/01-monoskope-cluster-values.yaml make helm-install-from-repo-monoskope
  needs:
    - job: deliver:chart:monoskope
      artifacts: false

deploy:monoskope:latest_tag:
  stage: deploy
  extends: .helm
  environment:
    name: figo-dev
  only:
    - schedules
  script:
    - VERSION=$(git describe --tags $(git rev-list --tags --max-count=1))
    - make helm-add-finleap
    - VERSION=$VERSION HELM_VALUES_FILE=examples/01-monoskope-cluster-values.yaml make helm-install-from-repo-monoskope
  needs: []
