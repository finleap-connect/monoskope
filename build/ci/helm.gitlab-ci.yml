# Copyright 2021 Monoskope Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

.helm:
  image: registry.gitlab.figo.systems/finleap-cloud-tools/helm-builder:2.0.0

lint:helm:
  stage: test
  extends: .helm
  except:
    - schedules
  script:
    - make helm-lint-gateway
    - make helm-lint-eventstore
    - make helm-lint-commandhandler
    - make helm-lint-queryhandler
    - make helm-dep-monoskope
    - make helm-lint-monoskope
  needs: []

chart:deliver:
  stage: chart
  extends: .helm
  only:
    - web
    - tags
  script:
    - VERSION=$(sh ./build/ci/configure_versions.sh)
    - VERSION=$VERSION make helm-set-version-all
    - build-chart --chart-dir build/package/helm/monoskope --promote-version $VERSION

deploy:monoskope:
  stage: deploy
  extends: .helm
  environment:
    name: figo-dev
  only:
    - web
    - tags
  script:
    - VERSION=$(sh ./build/ci/configure_versions.sh)
    - make helm-add-finleap
    - VERSION=$VERSION HELM_VALUES_FILE=examples/01-monoskope-cluster-values.yaml make helm-install-from-repo-monoskope

deploy:monoskope:latest_tag:
  stage: deploy
  extends: .helm
  environment:
    name: figo-dev
  only:
    - schedules
  script:
    - VERSION=$(git describe --tags $(git rev-list --tags --max-count=1))
    - echo "installing version $VERSION"
    - make helm-add-finleap
    - VERSION=$VERSION HELM_VALUES_FILE=examples/01-monoskope-cluster-values.yaml make helm-install-from-repo-monoskope
