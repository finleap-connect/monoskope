stages:
  - prepare
  - test
  - build
  - deliver
  - scan
  - deploy

include:
  - local: build/ci/golang.gitlab-ci.yml
  - local: build/ci/helm.gitlab-ci.yml
  # - template: Security/SAST.gitlab-ci.yml

.docker-builder:
  image: registry.gitlab.figo.systems/finleap-cloud-tools/docker-builder:1.5.4
  services:
    - gitlab.figo.systems/platform/dependency_proxy/containers/docker:18-dind
  only:
    - web

prepare:builder:
  stage: prepare
  extends: .docker-builder
  only:
    changes:
      - build/package/builder.Dockerfile
  except:
    - schedules
    - web
  script:
    - build-image --file build/package/builder.Dockerfile --tag $CI_PIPELINE_ID --image-suffix builder
