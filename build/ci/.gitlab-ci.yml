stages:
  - prepare
  - test
  - deliver

include:
  - local: build/ci/cache.gitlab-ci.yml

.test:
  extends: .cache-no-push

# build:builder:
#   stage: prepare
#   only:
#     changes:
#       - build/package/builder.Dockerfile
#   image: registry.gitlab.figo.systems/platform/docker-builder:1.4.2
#   services:
#     - gitlab.figo.systems/platform/dependency_proxy/containers/docker:18-dind
#   script:
#     - build-image --file build/package/builder.Dockerfile --tag $CI_PIPELINE_ID --image-suffix builder

lint:golang:
  stage: test
  extends: .test
  script:
    - make go-vet
    - make go-lint

lint:helm:
  stage: test
  image: registry.gitlab.figo.systems/platform/helm-builder:1.7.0
  only:
    - main
    - merge_requests
    - tags
  script:
    - make helm-lint
  needs: []

test:golang:
  stage: test
  extends: .test
  script:
    - make go-test

deliver:chart:
  stage: deliver
  only:
    - tag
  image: registry.gitlab.figo.systems/platform/helm-builder:1.7.0
  script:
    - VERSION=$(sh ./build/ci/configure_versions.sh)
    - build-chart --chart-dir ./build/package/helm --promote-version $VERSION
