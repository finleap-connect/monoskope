{{- if .Values.ingress.enabled }}
{{- $name := (printf "%s-%s" (include "gateway.name" .) "ingress") -}}
{{- $fullname := (printf "%s-%s" (include "gateway.fullname" .) "ingress") -}}
{{- $release := .Release.Name -}}
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/tls-acme: "true" # automatically request the certificate (using the in-cluster cert-manager)
    kubernetes.io/ingress.class: "nginx" # use the nginx ingress controller
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
  name: {{ $fullname }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  tls:
  - hosts:
    - {{ .Values.ingress.host }}
    secretName: {{ $name }}-tls
  rules:
    - host: {{ .Values.ingress.host }}
      http:
        paths:
        - path: /
          backend:
            serviceName: {{ (printf "%s-%s" $release "gateway-service") }}
            servicePort: http
{{- end }}