# Default values for monoskope.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

name: &name monoskope
nameOverride: ""
fullnameOverride: ""

global:
  imagePullSecrets: []
  labels:
    app.kubernetes.io/part-of: *name

pki:
  enabled: true
  certificates:
    duration: 2160h # 90d
    renewBefore: 1440h # 60d
  issuer:
    ca:
      enabled: true
      existingTrustAnchorSecretName: "m8-trust-anchor"
      secretVersion: 1 # Only necessary if .pkio.issuer.ca.existingTrustAnchorSecretName is not specified and VaultOperator is used
    vault: # Matches the .spec.vault of the cert-manager.io/v1 Issuer https://cert-manager.io/docs/configuration/vault/
      enabled: false
      path: pki_int/sign/example-dot-com
      server: https://vault.local
  authentication:
    keySecretName: &authKeySecretName "m8-authentication"

hosting:
  issuer: ""
  domain: &domain monoskope.io

messageBus:
  routingKeyPrefix: "m8"
  clientConfigSecretName: &msgBusClientConfigSecretName "m8-messagebus-client-config"

monitoring:
  tenant: &tenant finleap-cloud

gateway:
  enabled: true
  replicaCount: 1
  auth:
    issuerURL: https://your-idp.com
  keySecret:
    name: *authKeySecretName
    
eventstore:
  enabled: true
  replicaCount: 1
  messageBus:
    existingSecret: *msgBusClientConfigSecretName
  storeDatabase:
    existingSecret: m8-eventstore-db-config

commandhandler:
  enabled: true
  replicaCount: 1

queryhandler:
  enabled: true
  replicaCount: 1
  messageBus:
    existingSecret: *msgBusClientConfigSecretName

cockroachdb:
  enabled: true
  dropExistingDatabase: false # ATTENTION: If true the existing database will be dropped on crdb init job, only when restoring backup
  image:
    repository: gitlab.figo.systems/platform/dependency_proxy/containers/cockroachdb/cockroach
    tag: v20.2.2
    imagePullPolicy: Always
  statefulset:
    replicas: 3 # ATTENTION: Do not scale down existing cluster here, see https://www.cockroachlabs.com/docs/v20.2/remove-nodes.html
    maxUnavailable: 1
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2
        memory: 2Gi
    annotations:
      linkerd.io/inject: disabled
  init:
    annotations:
      linkerd.io/inject: disabled
  storage:
    persistentVolume:
      size: "1Gi" # ATTENTION: Increase for PROD according to your use-case
  conf:
    # Total size in bytes for caches, shared evenly if there are multiple
    # storage devices. Size suffixes are supported (e.g. `1GB` and `1GiB`).
    # A percentage of physical memory can also be specified (e.g. `.25`).
    cache: 25%
    # Maximum memory capacity available to store temporary data for SQL clients,
    # including prepared queries and intermediate data rows during query
    # execution. Accepts numbers interpreted as bytes, size suffixes
    # (e.g. `1GB` and `1GiB`) or a percentage of physical memory (e.g. `.25`).
    maxSQLMemory: 25%
  tls:
    enabled: true
    certs:
      provided: true
      tlsSecret: true
      # Secret name for the client root cert.
      clientRootSecret: monoskope-crdb-root
      # Secret name for node cert.
      nodeSecret: monoskope-crdb-node
  labels:
    app.kubernetes.io/part-of: *name
  # CockroachDB's Prometheus operator ServiceMonitor support
  serviceMonitor:
    enabled: true
    labels:
      tenant: *tenant
      release: monitoring
      app.kubernetes.io/part-of: *name
    annotations: {}
    interval: 1m
    scrapeTimeout: 10s

rabbitmq:
  enabled: true
  replicaCount: 1
  persistence:
    enabled: false
  image:
    registry: gitlab.figo.systems/platform/dependency_proxy/containers
    tag: 3.8.9
    pullPolicy: Always
  loadDefinition:
    enabled: true
    existingSecret: monoskope-rabbitmq-load-definition
  extraPlugins: 'rabbitmq_auth_mechanism_ssl'
  extraConfiguration: |-
    load_definitions = /app/rabbitmq-definitions.json
    auth_mechanisms.1 = EXTERNAL
    ssl_cert_login_from = common_name
    ssl_options.depth = 2
  serviceAccount:
    create: false
  rbac:
    create: false
  service:
    tlsPort: 5671
    labels:
      app.kubernetes.io/part-of: *name
  auth:
    username: eventstore # admin user with read/write access
    password: "w1!!b3r3pl4c3d"  # this will be overwritten by the load definition wich takes the password from a generated secret
    existingErlangSecret: monoskope-rabbitmq-erlang-cookie
    tls:
      enabled: true
      failIfNoPeerCert: true
      sslOptionsVerify: verify_peer
      existingSecret: monoskope-rabbitmq-leaf
  statefulsetLabels:
    app.kubernetes.io/part-of: *name
  podAnnotations:
    linkerd.io/inject: disabled
  podLabels:
    app.kubernetes.io/part-of: *name
  metrics:
    enabled: true
    grafanaDashboard:
      enabled: true
      extraLabels:
        tenant: *tenant
        app.kubernetes.io/part-of: *name
    serviceMonitor:
      enabled: true
      additionalLabels:
        tenant: *tenant
        app.kubernetes.io/part-of: *name

ambassador:
  enabled: true
  replicaCount: 3
  image:
    repository: gitlab.figo.systems/platform/dependency_proxy/containers/datawire/ambassador
    tag: 1.12.4
  enableAES: false
  crds:
    create: false
  rbac:
    create: false
  serviceAccount:
    create: false
  scope:
    singleNamespace: true
  resources:
    limits:
      cpu: 4
      memory: 1000Mi
    requests:
      cpu: 100m
      memory: 512Mi
  metrics:
    serviceMonitor:
      enabled: true
      selector:
        tenant: *tenant
        release: monitoring

cluster-bootstrap-reactor:
  enabled: true
  keySecret:
    name: *authKeySecretName
  messageBus:
    existingSecret: *msgBusClientConfigSecretName