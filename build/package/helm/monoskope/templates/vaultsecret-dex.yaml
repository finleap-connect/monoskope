{{- if .Values.dex.config.existingSecret }}
{{- $fullname := (printf "%s-%s" (include "monoskope.fullname" .) "dex-config") -}}
apiVersion: vault.finleap.cloud/v1alpha1
kind: VaultSecret
metadata:
  name: {{ $fullname }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ .Values.dex.config.existingSecret }}
  data:
  - name: config.yaml
    variables:
    - name: gitlabClientId
      location:
        path: app/{{ .Release.Namespace }}/monoskope/gitlab
        field: clientID
    - name: gitlabClientSecret
      location:
        path: app/{{ .Release.Namespace }}/monoskope/gitlab
        field: clientSecret
    - name: gatewayAppSecret
      location:
        path: app/{{ .Release.Namespace }}/monoskope/gateway
        field: oidc-clientsecret
    template: |-
            {{- with .Values.dex.config }}
            issuer: {{ .issuer }}
            storage:
              type: {{ .storage.type }}
              config:
            {{- toYaml .storage.config | nindent 16 }}
            {{- if and $.Values.cockroachdb.enabled (eq $.Values.dex.config.storage.type "postgres") }}
                host: {{ (include "call-nested" (list $ "cockroachdb" "cockroachdb.fullname")) }}-public
            {{- end }}
            logger:
            {{- toYaml .logger | nindent 14 }}
            web:
              {{- if $.Values.dex.https }}
              https: {{ $.Values.dex.config.web.address }}:{{ $.Values.dex.ports.web.containerPort }}
              tlsCert: {{ .web.tlsCert }}
              tlsKey: {{ .web.tlsKey }}
              {{- else }}
              http: {{ $.Values.dex.config.web.address }}:{{ $.Values.dex.ports.web.containerPort }}
              {{- end }}
              {{- with $.Values.dex.config.web.allowedOrigins }}
              allowedOrigins: {{ . }}
              {{- end }}
            {{- if $.Values.dex.grpc }}
            grpc:
              addr: {{ $.Values.dex.config.grpc.address }}:{{ $.Values.dex.ports.grpc.containerPort }}
              tlsCert: {{ .grpc.tlsCert }}
              tlsKey: {{ .grpc.tlsKey }}
              tlsClientCA: {{ .grpc.tlsClientCA }}
            {{- end }}
            {{- if .connectors }}
            connectors:
            {{- toYaml .connectors | nindent 12 }}
            {{- end }}
            oauth2: {{ toYaml .oauth2 | nindent 14 }}
            {{- if .staticClients }}
            staticClients:
            {{- toYaml .staticClients | nindent 12 }}
            {{- end }}
            enablePasswordDB: {{ .enablePasswordDB }}
            {{- if .staticPasswords }}
            staticPasswords:
            {{- toYaml .staticPasswords | nindent 12 }}
            {{- end }}
            {{- end }}
{{- end }}
