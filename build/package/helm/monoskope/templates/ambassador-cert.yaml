{{- if ne .Values.hosting.domain "" }}
{{- $tlsSecretName := (include "monoskope.tlsSecretName" .) }}
{{- $mtlsSecretName := (include "monoskope.mtlsSecretName" .) }}
{{- $caSecretName := (include "monoskope.caSecretName" .) }}
{{- $domain := (include "monoskope.domain" .) }}
{{- $mtlsDomain := (include "monoskope.mtlsDomain" .) }}
apiVersion: getambassador.io/v2
kind: Host
metadata:
  name: {{ include "monoskope.fullname" . }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hostname: {{ $domain }}
  acmeProvider:
    authority: none
  tlsSecret:
    name: {{ $tlsSecretName }}
  tls:
    min_tls_version: v1.2
---
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: {{ $tlsSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ $tlsSecretName }}
  issuerRef:
    name: {{ .Values.hosting.issuer }}
    kind: ClusterIssuer
  dnsNames:
  - {{ $domain }}
---
{{- if .Values.hosting.mtls.enabled }}
apiVersion: cert-manager.io/v1alpha3
kind: Certificate
metadata:
  name: {{ $mtlsSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ $mtlsSecretName }}
  issuerRef:
    name: {{ include "monoskope.pkiIssuer" . }}
    kind: Issuer
  subject:
    organizations:
      - Monoskope
  dnsNames:
  - {{ $mtlsDomain }}
  usages:
  - server auth
  - client auth
---
apiVersion: getambassador.io/v2
kind: TLSContext
metadata:
  name: {{ include "monoskope.fullname" . }}-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hosts:
  - {{ $mtlsDomain }}
  - {{ $mtlsDomain }}:443
  secret: {{ $mtlsSecretName }}
  ca_secret: {{ $caSecretName }}
  cert_required: true
  min_tls_version: v1.2
{{- end }}
{{- end }}