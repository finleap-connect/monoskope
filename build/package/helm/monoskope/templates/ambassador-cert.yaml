{{- if ne .Values.hosting.domain "" }}
{{- $name := .Values.hosting.domain | replace "." "-" }}
apiVersion: getambassador.io/v2
kind: Host
metadata:
  name: {{ include "monoskope.fullname" . }}-{{ $name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hostname: {{ include "monoskope.domain" . }}
  acmeProvider:
    authority: none
  tlsSecret:
    name: {{ include "monoskope.tlsSecretName" . }}
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: {{ include "monoskope.tlsSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ include "monoskope.tlsSecretName" . }}
  issuerRef:
    name: {{ .Values.hosting.issuer }}
    kind: ClusterIssuer
  dnsNames:
  - {{ include "monoskope.domain" . }}
---
{{- if .Values.hosting.mtls.enabled }}
apiVersion: getambassador.io/v2
kind: Host
metadata:
  name: {{ include "monoskope.fullname" . }}-{{ $name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hostname: {{ include "monoskope.mtlsDomain" . }}
  acmeProvider:
    authority: none
  tlsSecret:
    name: {{ include "monoskope.mtlsSecretName" . }}
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: {{ include "monoskope.mtlsSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ include "monoskope.mtlsSecretName" . }}
  issuerRef:
    name: {{ include "monoskope.pkiName" . }}-issuer
    kind: Issuer
  dnsNames:
  - {{ include "monoskope.mtlsDomain" . }}
  usages:
  - client auth
  - server auth
---
apiVersion: getambassador.io/v2
kind: TLSContext
metadata:
  name: {{ $name }}-context-mtls
spec:
  hosts:
  - {{ include "monoskope.mtlsDomain" . }}
  secret: {{ include "monoskope.mtlsSecretName" . }}
  ca_secret: {{ include "monoskope.caSecretName" . }}
  cert_required: true
{{- end }}
{{- end }}