{{- if ne .Values.hosting.domain "" }}
{{- $tlsSecretName :=  (include "monoskope.tlsSecretName" .) }}
{{- $mtlsSecretName :=  (include "monoskope.mtlsSecretName" .) }}
{{- $caSecretName :=  (include "monoskope.caSecretName" .) }}
{{- $domain :=  (include "monoskope.domain" .) }}
{{- $mtlsDomain :=  (include "monoskope.mtlsDomain" .) }}
apiVersion: getambassador.io/v2
kind: Host
metadata:
  name: {{ .Release.Name }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hostname: {{ $domain }}
  acmeProvider:
    authority: none
  tlsSecret:
    name: {{ $tlsSecretName }}
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: {{ $tlsSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ $tlsSecretName }}
  issuerRef:
    name: {{ .Values.hosting.issuer }}
    kind: ClusterIssuer
  dnsNames:
  - {{ $domain }}
---
{{- if .Values.hosting.mtls.enabled }}
apiVersion: getambassador.io/v2
kind: Host
metadata:
  name: {{ .Release.Name }}-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hostname: {{ $mtlsDomain }}
  acmeProvider:
    authority: none
  tlsSecret:
    name: {{ $mtlsSecretName }}
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: {{ $mtlsSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  secretName: {{ $mtlsSecretName }}
  issuerRef:
    name: {{ include "monoskope.pkiName" . }}-issuer
    kind: Issuer
  dnsNames:
  - {{ $mtlsDomain }}
  usages:
  - client auth
  - server auth
---
apiVersion: getambassador.io/v2
kind: TLSContext
metadata:
  name: {{ .Release.Name }}-mtls-ctx
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  hosts:
  - {{ $mtlsDomain }}
  secret: {{ $mtlsSecretName }}
  ca_secret: {{ $caSecretName }}
  cert_required: true
{{- end }}
{{- end }}