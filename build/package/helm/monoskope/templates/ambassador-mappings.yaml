{{- $mtlsDomain := (include "monoskope.mtlsDomain" .) }}
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: {{ include "monoskope.fullname" . }}-gateway-mapping
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  grpc: true
  timeout_ms: 20000
  bypass_auth: true
  prefix: /gateway.Gateway/
  rewrite: /gateway.Gateway/
  service: {{.Release.Name}}-gateway:{{.Values.gateway.ports.grpcApi}}
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: {{ include "monoskope.fullname" . }}-gateway-version-mapping
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  grpc: true
  timeout_ms: 20000
  prefix: /common.ServiceInformationService/
  rewrite: /common.ServiceInformationService/
  service: {{.Release.Name}}-gateway:{{.Values.gateway.ports.grpcApi}}
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: {{ include "monoskope.fullname" . }}-gateway-version-mapping-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  grpc: true
  timeout_ms: 20000
  prefix: /common.ServiceInformationService/
  rewrite: /common.ServiceInformationService/
  bypass_auth: true
  host: "^{{$mtlsDomain}}:443$" # allow mtls to bypass auth plugin
  host_regex: true
  service: {{.Release.Name}}-gateway:{{.Values.gateway.ports.grpcApi}}
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: {{ include "monoskope.fullname" . }}-commandhandler-mapping
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  grpc: true
  timeout_ms: 20000
  prefix: /eventsourcing.CommandHandler/
  rewrite: /eventsourcing.CommandHandler/
  service: {{.Release.Name}}-commandhandler:{{.Values.commandhandler.ports.api}}
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: {{ include "monoskope.fullname" . }}-qh-usersvc-mapping
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  grpc: true
  timeout_ms: 20000
  prefix: /domain.UserService/
  rewrite: /domain.UserService/
  service: {{.Release.Name}}-queryhandler:{{.Values.queryhandler.ports.api}}
