{{- if .Values.ingress.enabled }}
{{- $fullname := (printf "%s-%s" (include "monoskope.fullname" .) "ingress") -}}
{{- $release := .Release.Name -}}
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/tls-acme: "true" # automatically request the certificate (using the in-cluster cert-manager)
    kubernetes.io/ingress.class: "nginx" # use the nginx ingress controller
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  name: {{ $fullname }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
spec:
  tls:
  - hosts:
    - {{ .Values.ingress.host }}
    secretName: {{ $fullname }}-tls
  rules:
    - host: {{ .Values.ingress.host }}
      http:
        paths:
        - path: /()(dex.*)
          backend:
            serviceName: {{ (printf "%s-%s" $release "dex") }}
            servicePort: http
{{- end }}