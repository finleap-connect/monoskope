# Copyright 2021 Monoskope Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{{- if and .Values.rabbitmq.enabled .Values.vaultOperator.enabled }}
apiVersion: vault.finleap.cloud/v1alpha1
kind: VaultSecret
metadata:
  name: {{ .Values.rabbitmq.auth.existingErlangSecret }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
    {{- with (.Values.labels | default .Values.global.labels) }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  data:
    - name: rabbitmq-erlang-cookie
      generator:
        name: password
        args: [32]
      location:
        path: {{ tpl (.Values.vaultOperator.basePath) . }}/rabbitmq
        field: erlangCookie
{{- end }}
{{- if .Values.rabbitmq.loadDefinition.enabled }}
---
apiVersion: vault.finleap.cloud/v1alpha1
kind: VaultSecret
metadata:
  name: {{ include "monoskope.fullname" . }}-rabbitmq-definitions
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monoskope.labels" . | nindent 4 }}
    {{- with (.Values.labels | default .Values.global.labels) }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  secretName: {{ .Values.rabbitmq.loadDefinition.existingSecret }}
  data:
    - name: adminPassword
      generator:
        name: password
        args: [32]
      location:
        path: {{ tpl (.Values.vaultOperator.basePath) . }}/rabbitmq
        field: adminPassword
    - name: rabbitmq-definitions.json
      variables:
      - name: adminPassword
        location:
          path: {{ tpl (.Values.vaultOperator.basePath) . }}/rabbitmq
          field: adminPassword
      template: |-
        {
          "users": [
            {
              "name": {{ .Values.rabbitmq.auth.username | quote }},
              "password": {{`{{ .adminPassword | quote }}`}},
              "tags": "administrator"
            }
          ],
          "vhosts": [{"name": "/"}],
          "permissions": [
            {
              "user": {{ .Values.rabbitmq.auth.username | quote }},
              "vhost": "/",
              "configure": ".*",
              "read": ".*",
              "write": ".*"
            }
          ],
          "parameters": [],
          "policies": [
              {
                  "vhost": "/",
                  "name": "ha",
                  "pattern": "",
                  "definition": {
                      "ha-mode": "exactly",
                      "ha-params": {{ add1 (div .Values.rabbitmq.replicaCount 2) }},
                  }
              }
          ],
          "queues": [],
          "exchanges": [],
          "bindings": []
        }
{{- end }}
